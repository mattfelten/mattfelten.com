---
import Section from '@components/Section.astro';
---

<Section title="Subscribe to my newsletter" class="line-length-lg">
	<p class="mb-2">
		This is where I drop quick notes about design, music, life,
		and whatever catches my attention. Think of it like a slow,
		quiet feed of things I'd send a friend.
	</p>
	<div class="space-y-2">
		<form
			id="newsletter-form"
			action="https://newsletter.mattfelten.com/api/v1/free"
			method="post"
			class="flex gap-2"
		>
			<div class="bg-background w-full">
				<input
					id="newsletter-email"
					class="bg-strong/10 focus-visible:bg-strong/7 w-full rounded-md border-none p-1.5 transition-colors focus:outline-0"
					type="email"
					name="email"
					placeholder="name@example.com"
					required
				/>
			</div>
			<button
				id="newsletter-submit"
				class="text-background bg-accent focus-visible:bg-accent/90 cursor-pointer rounded-md p-1.5 font-medium focus:outline-0 disabled:cursor-not-allowed disabled:opacity-50"
				type="submit"
			>
				Subscribe
			</button>
		</form>
		<div id="newsletter-success" class="hidden">
			<p class="text-accent font-medium">
				Thanks for subscribing! Check your email to confirm.
			</p>
		</div>
		<div id="newsletter-error" class="hidden">
			<p class="font-medium text-red-500">
				Something went wrong. Please try again later.
			</p>
		</div>
	</div>
</Section>

<script>
	const form = document.getElementById(
		'newsletter-form'
	) as HTMLFormElement | null;
	const emailInput = document.getElementById(
		'newsletter-email'
	) as HTMLInputElement | null;
	const submitButton = document.getElementById(
		'newsletter-submit'
	) as HTMLButtonElement | null;
	const successMessage = document.getElementById(
		'newsletter-success'
	);
	const errorMessage = document.getElementById('newsletter-error');

	if (
		form &&
		emailInput &&
		submitButton &&
		successMessage &&
		errorMessage
	) {
		form.addEventListener('submit', async e => {
			e.preventDefault();

			const email = emailInput.value;
			if (!email) return;

			// Disable form during submission
			submitButton.disabled = true;
			errorMessage.classList.add('hidden');

			try {
				// Use URLSearchParams for application/x-www-form-urlencoded
				const params = new URLSearchParams();
				params.append('email', email);

				const response = await fetch(
					'https://newsletter.mattfelten.com/api/v1/free',
					{
						method: 'POST',
						headers: {
							'Content-Type':
								'application/x-www-form-urlencoded',
						},
						body: params.toString(),
					}
				);

				// Treat any response that's not a client/server error (4xx/5xx) as success
				// This handles cases where the API doesn't return a standard response
				if (response.status < 400) {
					// Hide form and show success message
					form.classList.add('hidden');
					successMessage.classList.remove('hidden');
					emailInput.value = '';
				} else {
					// Show error message for 4xx/5xx responses
					errorMessage.classList.remove('hidden');
					submitButton.disabled = false;
				}
			} catch (error) {
				// Log error for debugging
				console.error(
					'Newsletter subscription error:',
					error
				);
				// Show error message
				errorMessage.classList.remove('hidden');
				submitButton.disabled = false;
			}
		});
	}
</script>
