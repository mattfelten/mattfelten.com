---
import Section from '@components/Section.astro';
---

<Section title="Subscribe to my newsletter" class="line-length-lg">
	<p class="mb-2">
		This is where I drop quick notes about design, music, life,
		and whatever catches my attention. Think of it like a slow,
		quiet feed of things I'd send a friend.
	</p>
	<div class="space-y-2">
		<form id="newsletter-form" class="flex gap-2">
			<div class="bg-background w-full">
				<input
					id="newsletter-email"
					class="bg-strong/10 focus-visible:bg-strong/7 w-full rounded-md border-none p-1.5 transition-colors focus:outline-0"
					type="email"
					name="email"
					placeholder="name@example.com"
					required
				/>
			</div>
			<button
				id="newsletter-submit"
				class="text-background bg-accent focus-visible:bg-accent/90 relative cursor-pointer rounded-md p-1.5 font-medium whitespace-nowrap focus:outline-0 disabled:cursor-not-allowed disabled:text-transparent disabled:opacity-50 disabled:*:block"
				type="submit"
			>
				<svg
					class="-mt-1-5 -ml-1-5 text-background absolute top-1/2 left-1/2 hidden size-3 animate-spin [animation-duration:.6s]"
					xmlns="http://www.w3.org/2000/svg"
					fill="none"
					viewBox="0 0 24 24"
					><circle
						class="opacity-25"
						cx="12"
						cy="12"
						r="10"
						stroke="currentColor"
						stroke-width="4"></circle><path
						class="opacity-75"
						fill="currentColor"
						d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
					></path></svg
				>
				Subscribe
			</button>
		</form>
		<div id="newsletter-success" class="hidden">
			<p class="text-accent font-medium">
				Thanks for subscribing! Check your email to confirm.
			</p>
		</div>
		<div id="newsletter-error" class="hidden">
			<p class="font-medium text-red-500">
				Something went wrong. Please try again later.
			</p>
		</div>
	</div>
</Section>

<script>
	import { actions } from 'astro:actions';

	const form = document.getElementById(
		'newsletter-form'
	) as HTMLFormElement | null;
	const emailInput = document.getElementById(
		'newsletter-email'
	) as HTMLInputElement | null;
	const submitButton = document.getElementById(
		'newsletter-submit'
	) as HTMLButtonElement | null;
	const successMessage = document.getElementById(
		'newsletter-success'
	);
	const errorMessage = document.getElementById('newsletter-error');

	if (
		form &&
		emailInput &&
		submitButton &&
		successMessage &&
		errorMessage
	) {
		form.addEventListener('submit', async e => {
			e.preventDefault();

			const email = emailInput.value.trim();
			if (!email) return;

			// Disable form during submission
			submitButton.disabled = true;
			emailInput.disabled = true;
			errorMessage.classList.add('hidden');
			successMessage.classList.add('hidden');

			const { data, error } = await actions.subscribe({
				email,
			});

			emailInput.disabled = false;
			submitButton.disabled = false;

			if (error) {
				errorMessage.classList.remove('hidden');
				return;
			}

			successMessage.classList.remove('hidden');
			emailInput.value = '';
		});
	}
</script>
